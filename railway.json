{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm install --omit=dev",
    "nixpacksConfig": {
      "phases": {
        "setup": {
          "aptPkgs": ["openssl", "ca-certificates", "curl", "wget"]
        },
        "install": {
          "cmds": [
            "export NPM_CONFIG_CACHE=/tmp/.npm",
            "npm install --omit=dev"
          ]
        },
        "build": {
          "cmds": [
            "echo 'Building TimeBloc Backend...'",
            "npm run build || true"
          ]
        }
      }
    }
  },
  "deploy": {
    "numReplicas": 1,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3,
    "startCommand": "node --max-old-space-size=512 --trace-warnings server.js",
    "healthcheckPath": "/api/health",  // ✅ CHANGED from "/" to "/api/health"
    "healthcheckTimeout": 5,           // ✅ CHANGED from 30 to 5 seconds
    "healthcheckInterval": 30,         // ✅ CHANGED from 60 to 30 seconds
    "healthcheckMaxRetries": 5,        // ✅ CHANGED from 3 to 5
    "webSocket": true,
    "stickySessions": true,
    "firewall": {
      "enabled": true,
      "rules": [
        {
          "port": 3000,
          "protocol": "tcp",
          "source": "0.0.0.0/0",
          "description": "Allow HTTP and WebSocket traffic"
        },
        {
          "port": 443,
          "protocol": "tcp",
          "source": "0.0.0.0/0",
          "description": "Allow HTTPS traffic"
        }
      ]
    },
    "scaling": {
      "min": 1,
      "max": 2,
      "cpuThreshold": 80,
      "memoryThreshold": 85
    }
  },
  "env": {
    "NODE_ENV": "production",
    "NODE_OPTIONS": "--max-old-space-size=512 --trace-warnings",
    "ENABLE_WEBSOCKETS": "true",
    "SOCKET_IO_TRANSPORTS": "polling,websocket",
    "UV_THREADPOOL_SIZE": "16",
    "NODE_CLUSTER_SCHED_POLICY": "rr",
    "DISABLE_HTTP_LOGGING": "false",
    "ENABLE_SECURITY_HEADERS": "true",
    "PORT": "3000",
    "APP_NAME": "TimeBloc Backend",
    "APP_VERSION": "1.0.0",
    "APP_ENVIRONMENT": "production",
    "NPM_CONFIG_PRODUCTION": "false",
    "NPM_CONFIG_CACHE": "/tmp/.npm"
  },
  "service": {
    "name": "timebloc-backend",
    "description": "TimeBloc Secure Backend API with Socket.io",
    "tags": ["nodejs", "socket.io", "api", "security"],
    "icon": "https://raw.githubusercontent.com/railwayapp/branding/main/logos/logo-light.svg"
  },
  "healthChecks": [
    {
      "path": "/api/health",    // ✅ CHANGED from "/" to "/api/health"
      "interval": 30,
      "timeout": 10,
      "retries": 3,
      "initialDelay": 5
    }
  ],
  "resources": {
    "cpu": 1,
    "memory": 512,
    "ephemeralStorage": 1024
  },
  "deploymentStrategy": {
    "type": "rolling",
    "maxUnavailable": "25%",
    "maxSurge": "25%"
  },
  "monitoring": {
    "enabled": true,
    "alerts": {
      "cpu": 90,
      "memory": 90,
      "disk": 80
    }
  },
  "logging": {
    "enabled": true,
    "level": "info",
    "format": "json",
    "retention": "7d"
  },
  "network": {
    "ingress": {
      "enabled": true,
      "rules": [
        {
          "host": "*",
          "path": "/*",
          "servicePort": 3000
        }
      ]
    },
    "egress": {
      "enabled": true,
      "rules": [
        {
          "description": "Allow outbound to Supabase",
          "protocol": "tcp",
          "port": 443,
          "destination": "*.supabase.co"
        },
        {
          "description": "Allow outbound to NowPayments",
          "protocol": "tcp",
          "port": 443,
          "destination": "api.nowpayments.io"
        }
      ]
    }
  }
}