{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm ci --only=production --frozen-lockfile --ignore-scripts",
    "nixpacksConfig": {
      "phases": {
        "setup": {
          "aptPkgs": ["openssl", "ca-certificates", "curl", "wget"]
        },
        "install": {
          "cmds": [
            "npm ci --only=production --frozen-lockfile --ignore-scripts"
          ]
        },
        "build": {
          "cmds": [
            "echo 'Building TimeBloc Backend...'",
            "npm run build || true"
          ]
        }
      }
    }
  },
  "deploy": {
    "numReplicas": 1,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3,
    "startCommand": "node --max-old-space-size=512 --trace-warnings server.js",
    "healthcheckPath": "/",
    "healthcheckTimeout": 30,
    "healthcheckInterval": 60,
    "healthcheckMaxRetries": 3,
    
    // ✅ CRITICAL: Enable WebSockets for Socket.io
    "webSocket": true,
    
    // ✅ Enable sticky sessions for Socket.io
    "stickySessions": true,
    
    "firewall": {
      "enabled": true,
      "rules": [
        {
          "port": 3000,
          "protocol": "tcp",
          "source": "0.0.0.0/0",
          "description": "Allow HTTP and WebSocket traffic"
        },
        {
          "port": 443,
          "protocol": "tcp", 
          "source": "0.0.0.0/0",
          "description": "Allow HTTPS traffic"
        }
      ]
    },
    "scaling": {
      "min": 1,
      "max": 2,
      "cpuThreshold": 80,
      "memoryThreshold": 85
    }
  },
  "env": {
    "NODE_ENV": "production",
    "NODE_OPTIONS": "--max-old-space-size=512 --trace-warnings",
    
    // ✅ Socket.io Optimization
    "ENABLE_WEBSOCKETS": "true",
    "SOCKET_IO_TRANSPORTS": "polling,websocket",
    
    // ✅ Performance Tuning
    "UV_THREADPOOL_SIZE": "16",
    "NODE_CLUSTER_SCHED_POLICY": "rr",
    
    // ✅ Security
    "DISABLE_HTTP_LOGGING": "false",
    "ENABLE_SECURITY_HEADERS": "true",
    
    // ✅ Port Configuration
    "PORT": "3000",
    
    // ✅ Application Settings
    "APP_NAME": "TimeBloc Backend",
    "APP_VERSION": "1.0.0",
    "APP_ENVIRONMENT": "production"
  },
  
  // ✅ Service Configuration
  "service": {
    "name": "timebloc-backend",
    "description": "TimeBloc Secure Backend API with Socket.io",
    "tags": ["nodejs", "socket.io", "api", "security"],
    "icon": "https://raw.githubusercontent.com/railwayapp/branding/main/logos/logo-light.svg"
  },
  
  // ✅ Health Check Configuration
  "healthChecks": [
    {
      "path": "/",
      "interval": 30,
      "timeout": 10,
      "retries": 3,
      "initialDelay": 5
    },
    {
      "path": "/api/health",
      "interval": 60,
      "timeout": 15,
      "retries": 2,
      "initialDelay": 10
    }
  ],
  
  // ✅ Resource Limits
  "resources": {
    "cpu": 1,
    "memory": 512,
    "ephemeralStorage": 1024
  },
  
  // ✅ Deployment Strategy
  "deploymentStrategy": {
    "type": "rolling",
    "maxUnavailable": "25%",
    "maxSurge": "25%"
  },
  
  // ✅ Monitoring
  "monitoring": {
    "enabled": true,
    "alerts": {
      "cpu": 90,
      "memory": 90,
      "disk": 80
    }
  },
  
  // ✅ Logging Configuration
  "logging": {
    "enabled": true,
    "level": "info",
    "format": "json",
    "retention": "7d"
  },
  
  // ✅ Network Configuration
  "network": {
    "ingress": {
      "enabled": true,
      "rules": [
        {
          "host": "*",
          "path": "/*",
          "servicePort": 3000
        }
      ]
    },
    "egress": {
      "enabled": true,
      "rules": [
        {
          "description": "Allow outbound to Supabase",
          "protocol": "tcp",
          "port": 443,
          "destination": "*.supabase.co"
        },
        {
          "description": "Allow outbound to NowPayments",
          "protocol": "tcp", 
          "port": 443,
          "destination": "api.nowpayments.io"
        }
      ]
    }
  }
}